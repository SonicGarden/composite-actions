name: 'Claude Code Action'
description: 'Run Claude Code with project setup'
inputs:
  additional_claude_args:
    description: 'Arguments for Claude Code (model, allowed tools, mcp configs, etc)'
    required: false
    default: ''
  additional_system_prompt:
    description: 'Additional system prompt'
    required: false
    default: |
      # è¨€èªè¨­å®š
      **é‡è¦**: ã™ã¹ã¦ã®å‡ºåŠ›ã¯å¿…ãšæ—¥æœ¬èªã§è¡Œã£ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™ï¼š
      - GitHubã®Issueã‚„PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ
      - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨è§£æ±ºæ–¹æ³•ã®èª¬æ˜
      - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã®ãƒ¬ãƒãƒ¼ãƒˆ
      - ä½œæ¥­å†…å®¹ã®èª¬æ˜
      - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  claude_code_oauth_token:
    description: 'Claude Code OAuth token'
    required: true

outputs:
  execution_file:
    description: 'Claude execution file path'
    value: ${{ steps.claude.outputs.execution_file }}

runs:
  using: 'composite'
  steps:
    - name: Add processing reaction
      uses: SonicGarden/composite-actions/add-processing-reaction@main
      with:
        github-token: ${{ github.token }}

    - name: Extract event text
      id: event-text
      uses: SonicGarden/composite-actions/extract-event-text@main

    - name: Extract base branch
      id: extract-base
      shell: bash
      env:
        EVENT_TEXT: ${{ steps.event-text.outputs.text }}
      run: |
        # --base=ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŠ½å‡º (ä¾‹: --base=branch_name)
        if [[ "$EVENT_TEXT" =~ --base=([^[:space:]]+) ]]; then
          BASE_BRANCH="${BASH_REMATCH[1]}"
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "Base branch extracted: $BASE_BRANCH"
        else
          echo "No base branch specified"
        fi

    - name: Check if setup is needed
      id: check-setup-needed
      if: ${{ !contains(steps.event-text.outputs.text, '-setup') }}
      uses: SonicGarden/composite-actions/check-claude-setup-needed@main
      with:
        claude_code_oauth_token: ${{ inputs.claude_code_oauth_token }}
        event_text: ${{ steps.event-text.outputs.text }}

    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    - name: Check for Project Setup Action
      id: check-project-setup
      shell: bash
      run: |
        if [ -d ".github/actions/project-setup" ] && [ -f ".github/actions/project-setup/action.yml" -o -f ".github/actions/project-setup/action.yaml" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Project-specific setup action found"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "No project-specific setup action found"
        fi

    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
    - name: Run Project Setup
      id: project-setup
      if: |
        steps.check-project-setup.outputs.exists == 'true' &&
        (contains(steps.event-text.outputs.text, '-setup') ||
         steps.check-setup-needed.outputs.needs_setup == 'true')
      uses: ./.github/actions/project-setup

    - name: Run Claude Code
      id: claude
      uses: anthropics/claude-code-action@2086c977a558a1b8f4aa65390617b17135d53515
      env:
        SYSTEM_PROMPT: |
          - REPO: ${{ github.repository }}
          - ISSUE_NUMBER: ${{ github.event.issue.number }}
          - PR_NUMBER: ${{ github.event.pull_request.number }}

          ${{ steps.project-setup.outcome == 'success' && '# ğŸš€ é–‹ç™ºç’°å¢ƒæº–å‚™å®Œäº†
          - **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç’°å¢ƒ: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†** âœ…
          - **ã™ãã«ã‚³ãƒ¼ãƒ‰å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå¯èƒ½ãªçŠ¶æ…‹ã§ã™**
          - ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: å®Œäº†
          - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆå¿…è¦ãªå ´åˆï¼‰: æ¥ç¶šè¨­å®šæ¸ˆã¿
          - ãƒ†ã‚¹ãƒˆç’°å¢ƒ: å®Ÿè¡Œå¯èƒ½
          - è¿½åŠ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚„ç’°å¢ƒæ§‹ç¯‰ã¯ä¸è¦ã§ã™' || '' }}

          ${{ inputs.additional_system_prompt }}
      with:
        claude_code_oauth_token: ${{ inputs.claude_code_oauth_token }}
        base_branch: ${{ steps.extract-base.outputs.base_branch || '' }}
        additional_permissions: |
          actions: read
        claude_args: |
          ${{ contains(steps.event-text.outputs.text, '-opus') && '--model claude-opus-4-1-20250805' || '' }}
          --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git fetch:*),Bash(git checkout:*),Bash(gh:*),WebFetch,WebSearch,mcp__github__get_issue,mcp__github__create_issue,mcp__github__add_sub_issue,mcp__github__list_sub_issues,mcp__github__remove_sub_issue,mcp__github__reprioritize_sub_issue,mcp__github__update_issue,mcp__context7__*,mcp__deepwiki__*"
          --append-system-prompt "${{ env.SYSTEM_PROMPT }}"
          --mcp-config '{"mcpServers":{"deepwiki":{"type":"http","url":"https://mcp.deepwiki.com/mcp"},"context7":{"type":"sse","url":"https://mcp.context7.com/sse"}}}'
          ${{ inputs.additional_claude_args }}
        settings: ".claude/settings.json"
